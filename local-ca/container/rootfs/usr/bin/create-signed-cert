#!/bin/sh

# Generate the key
if [ ! -f "/data/$1.key" ]; then
  openssl genrsa \
    -out /data/$1.key \
    2048
  
  # Make the key read-only and private
  chmod 0400 /data/$1.key
fi

# Generate the certificate 
if [ ! -f "/data/$1.crt" ]; then
  # Generate the CSR
  openssl req \
    -nodes \
    -key /data/$1.key \
    -config /config/$1.cnf \
    -out /tmp/$1.csr

  # Use the CSR to generate a certificate, signed using the local CA cert
  openssl x509 \
    -req \
    -CA /data/ca.crt \
    -CAkey /data/ca.key \
    -CAcreateserial \
    -in /tmp/$1.csr \
    -extfile /config/$1.cnf \
    -out /data/$1.crt \
    -days 365 \
    -extensions v3_req

  # Make the certificate read-only
  chmod 0640 /data/$1.crt

  # Clean up the CSR
  rm -f /tmp/$1.csr
fi